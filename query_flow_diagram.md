# RAG Chatbot Query Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 FRONTEND                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│  User Types Query → sendMessage() → POST /api/query                            │
│  script.js:45      script.js:63     { query, session_id }                      │
│                                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────┐                          │
│  │   User Input        │    │   Loading Animation  │                          │
│  │   Disabled          │    │   Displayed          │                          │
│  └─────────────────────┘    └──────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FASTAPI SERVER                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│  POST /api/query → query_documents() → rag_system.query()                      │
│  app.py:56        app.py:57           app.py:66                                │
│                                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────┐                          │
│  │  QueryRequest       │    │  Create Session      │                          │
│  │  Validation         │    │  if needed           │                          │
│  └─────────────────────┘    └──────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               RAG SYSTEM                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│  RAGSystem.query() → Create Prompt → Get History → AI Generator                │
│  rag_system.py:102   rag_system.py:114  rag_system.py:119  rag_system.py:122  │
│                                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────┐                          │
│  │  Session Manager    │    │   Tool Manager       │                          │
│  │  Get History        │    │   Tool Definitions   │                          │
│  └─────────────────────┘    └──────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             AI GENERATOR                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│  generate_response() → Build Params → Claude API → Handle Tools                │
│  ai_generator.py:43    ai_generator.py:68  ai_generator.py:80  ai_generator.py:84│
│                                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────┐                          │
│  │  System Prompt +    │    │   Anthropic Claude   │                          │
│  │  Conversation       │    │   API Call           │                          │
│  └─────────────────────┘    └──────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                     ┌──────────────────┴──────────────────┐
                     ▼                                     ▼
      ┌─────────────────────────┐              ┌─────────────────────────┐
      │    DIRECT RESPONSE      │              │     TOOL EXECUTION      │
      │                         │              │                         │
      │  Claude answers from    │              │  Claude requests        │
      │  general knowledge      │              │  search_course_content  │
      └─────────────────────────┘              └─────────────────────────┘
                     │                                     │
                     │                                     ▼
                     │              ┌─────────────────────────────────────┐
                     │              │          SEARCH TOOL                │
                     │              ├─────────────────────────────────────┤
                     │              │  CourseSearchTool.execute()         │
                     │              │  search_tools.py:52                 │
                     │              │                                     │
                     │              │  ┌─────────────┐ ┌─────────────┐   │
                     │              │  │   Query     │ │  Optional   │   │
                     │              │  │ Processing  │ │  Filters    │   │
                     │              │  └─────────────┘ └─────────────┘   │
                     │              └─────────────────────────────────────┘
                     │                                     │
                     │                                     ▼
                     │              ┌─────────────────────────────────────┐
                     │              │         VECTOR STORE                │
                     │              ├─────────────────────────────────────┤
                     │              │  VectorStore.search()               │
                     │              │  vector_store.py                    │
                     │              │                                     │
                     │              │  ┌─────────────┐ ┌─────────────┐   │
                     │              │  │  ChromaDB   │ │ Sentence    │   │
                     │              │  │  Semantic   │ │ Transformer │   │
                     │              │  │  Search     │ │ Embeddings  │   │
                     │              │  └─────────────┘ └─────────────┘   │
                     │              └─────────────────────────────────────┘
                     │                                     │
                     │                                     ▼
                     │              ┌─────────────────────────────────────┐
                     │              │      SEARCH RESULTS                 │
                     │              │                                     │
                     │              │  • Relevant document chunks         │
                     │              │  • Course & lesson metadata        │
                     │              │  • Source tracking                 │
                     │              │  • Formatted for Claude            │
                     │              └─────────────────────────────────────┘
                     │                                     │
                     │              ┌──────────────────────┘
                     │              ▼
                     │    ┌─────────────────────────────────────┐
                     │    │     FINAL AI RESPONSE               │
                     │    │                                     │
                     │    │  Claude synthesizes search results  │
                     │    │  into coherent answer              │
                     │    └─────────────────────────────────────┘
                     │                        │
                     └────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            RESPONSE ASSEMBLY                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Update History → Extract Sources → Return Response                            │
│  rag_system.py:137  rag_system.py:130  rag_system.py:140                      │
│                                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────┐                          │
│  │  Session Manager    │    │   QueryResponse      │                          │
│  │  Store Exchange     │    │   (answer, sources)  │                          │
│  └─────────────────────┘    └──────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           FASTAPI RESPONSE                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│  JSON Response → QueryResponse Model → HTTP 200                                │
│  app.py:68      { answer, sources, session_id }                               │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           FRONTEND DISPLAY                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Remove Loading → Display Answer → Show Sources → Re-enable Input              │
│  script.js:84     script.js:85      script.js:124    script.js:92             │
│                                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────┐                          │
│  │   Markdown          │    │   Collapsible        │                          │
│  │   Rendering         │    │   Sources Section    │                          │
│  └─────────────────────┘    └──────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘

KEY COMPONENTS:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   Web Interface │  │  FastAPI Server │  │   RAG System    │  │  Vector Store   │
│   (HTML/JS/CSS) │  │   (Python)      │  │   (Python)      │  │   (ChromaDB)    │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘

FLOW TYPES:
• General Knowledge: User Query → Claude → Direct Response
• Course Content: User Query → Claude → Tool Search → Vector Store → Enhanced Response
```